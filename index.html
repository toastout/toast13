<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ–¼ï¸ ê³µìœ  ì‘ì—…ì‹¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ë¯¸ë¦¬ë³´ê¸° ìˆ˜ì • ì™„ë£Œ v5 */
    :root {
      --bg-color: #f8f9fa; --text-color: #212529; --border-color: #dee2e6;
      --section-bg: #ffffff; --btn-bg: #e9ecef; --btn-hover-bg: #dee2e6;
      --accent-btn-bg: #228be6; --accent-btn-hover-bg: #1c7ed6;
    }
    body {
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0; padding: 20px;
      background-color: var(--bg-color); color: var(--text-color);
      display: flex; justify-content: center; align-items: flex-start;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .container {
      width: 100%;
      max-width: 800px;
      background-color: var(--section-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
	  overflow: hidden;  /* ì¶”ê°€ */
    }
    h1 { text-align: center; margin-top: 0; }
    p.subtitle { color: #868e96; line-height: 1.6; text-align: center; margin-bottom: 30px; }
    
    .upload-box {
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      padding: 40px 20px;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      text-align: center;
      min-height: 150px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .upload-box:hover, .upload-box.dragover { 
      background-color: var(--bg-color); 
      border-color: var(--accent-btn-bg); 
    }
    .upload-box p { margin: 5px 0; }
    .upload-box .hint { font-size: 0.85rem; color: #868e96; }
    
    #file-input { display: none; }
    
    /* ì´ë¯¸ì§€ ëª©ë¡ */
    .image-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin: 20px 0;
	  overflow: hidden;  /* ì¶”ê°€ */
    }
    .image-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: var(--bg-color);
      border-bottom: 1px solid var(--border-color);
	  overflow: hidden;  /* ì¶”ê°€ */
    }
    .image-item:first-child { border-radius: 8px 8px 0 0; }
    .image-item:last-child { border-radius: 0 0 8px 8px; border-bottom: none; }
    .image-item:only-child { border-radius: 8px; }
    
    /* ìˆœì„œ ì¡°ì • ë²„íŠ¼ */
    .order-buttons {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .order-buttons button {
      background: var(--btn-bg);
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .order-buttons button:hover:not(:disabled) { background: var(--btn-hover-bg); }
    .order-buttons button:disabled { opacity: 0.3; cursor: not-allowed; }
    
    /* ì¸ë„¤ì¼ */
    .image-item .thumbnail {
      width: 80px;
      height: 80px;
      flex-shrink: 0;
      border-radius: 6px;
      overflow: hidden;
      background: var(--section-bg);
      position: relative;
    }
    .image-item .thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
    }
    
    /* ì •ë³´ + ë²„íŠ¼ ì˜ì—­ */
    .image-item .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }
    .image-item .info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .image-item .name {
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .image-item .size {
      font-size: 0.8rem;
      color: #868e96;
    }
    
    /* ê¸°ëŠ¥ ë²„íŠ¼ë“¤ */
    .image-item .item-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .image-item .item-btn {
      background: var(--btn-bg);
      border: none;
      font-size: 0.85rem;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 6px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .image-item .item-btn:hover { background: var(--btn-hover-bg); }
    .image-item .item-btn.remove-btn { background: #ffe3e3; color: #c92a2a; }
    .image-item .item-btn.remove-btn:hover { background: #ffc9c9; }
    
    .controls-panel { display: flex; flex-direction: column; gap: 20px; margin-top: 20px; }
    .control-group { background: var(--bg-color); padding: 20px; border-radius: 8px; }
    .control-group h3 { margin-top: 0; margin-bottom: 15px; }
    
    label { font-weight: 600; font-size: 0.9rem; display: block; margin-bottom: 5px; }
    
    .direction-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    .direction-buttons button {
      flex: 1; min-width: 80px;
      padding: 12px 8px;
      font-size: 1rem;
      background: var(--btn-bg);
      color: var(--text-color);
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .direction-buttons button.active {
      background: var(--accent-btn-bg);
      color: #fff;
    }
    .direction-buttons button:hover:not(.active) { background: var(--btn-hover-bg); }
    
    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    input[type="number"], input[type="color"], select {
      width: 100%; 
      box-sizing: border-box; 
      padding: 8px; 
      font-size: 0.9rem;
      border: 1px solid var(--border-color); 
      border-radius: 6px;
      background-color: var(--section-bg); 
      color: inherit;
    }
    input[type="color"] { height: 40px; padding: 4px; cursor: pointer; }
    select { cursor: pointer; }
    
    .stepper { display: flex; align-items: center; gap: 5px; }
    .stepper input { text-align: center; flex: 1; }
    .stepper-btns { display: flex; flex-direction: column; }
    .stepper-btns button { 
      padding: 1px 6px; font-size: 0.8rem; 
      height: 18px; width: 25px; 
      background: var(--btn-bg); color: var(--text-color); 
      border: none; border-radius: 4px; cursor: pointer;
    }
    
    .grid-options { 
      display: none; 
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }
    .grid-options.visible { display: block; }
    
    /* í¬ê¸° ì§ì ‘ ì…ë ¥ ì˜ì—­ */
    .custom-size-options {
      display: none;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }
    .custom-size-options.visible { display: block; }
    .custom-size-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .custom-size-row> div { flex: 1; min-width: 100px; }
    .custom-size-row select { min-width: 70px; }
    .size-lock-btn {
      background: var(--btn-bg);
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    .size-lock-btn:hover { background: var(--btn-hover-bg); }
    
    .preview-section { margin-top: 20px; text-align: center; }
    .preview-section h3 { margin-bottom: 15px; }
    #preview-canvas {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .action-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    .action-buttons button {
      flex: 1; min-width: 120px;
      border: none;
      padding: 15px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .add-more-btn { background: var(--btn-bg); color: var(--text-color); }
    .add-more-btn:hover { background: var(--btn-hover-bg); }
    .clear-btn { background: #fa5252; color: #fff; }
    .clear-btn:hover { background: #e03131; }
    
    /* ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ê°€ìš´ë° ì •ë ¬ */
    .download-buttons {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    .download-btn { 
      background: var(--accent-btn-bg); 
      color: #fff; 
      border: none;
      padding: 15px 40px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .download-btn:hover { background: var(--accent-btn-hover-bg); }
    .download-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .clear-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .header-controls { 
      position: fixed; top: 20px; right: 20px; 
      display: flex; gap: 10px; z-index: 100;
    }
    .header-controls button {
      background-color: var(--btn-bg);
      color: var(--text-color);
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }
    .header-controls button:hover { background-color: var(--btn-hover-bg); }
    
    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 500px) {
      .image-item { flex-wrap: wrap; }
      .image-item .content { width: 100%; }
      .custom-size-row> div { min-width: 80px; }
    }
  </style>
</head>
<body>
  <div class="header-controls">
    <button id="main-link" title="ëŒì•„ê°€ê¸°">ğŸï¸</button>
    <button id="cleaner-link" title="ì„¸íƒì†Œ">ğŸ§¼</button>
  </div>
  
  <div class="container">
    <h1>ğŸ–¼ï¸ ê³µìœ  ì‘ì—…ì‹¤</h1>
    <p class="subtitle">ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ê°€ë¡œ, ì„¸ë¡œ, ë°”ë‘‘íŒìœ¼ë¡œ ì´ì–´ë¶™ì´ê¸°</p>
    
    <div id="upload-box" class="upload-box">
      <p>ğŸ–¼ï¸ ì´ê³³ì„ í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>
      <p class="hint">ì—¬ëŸ¬ ì¥ì„ í•œ ë²ˆì— ì„ íƒí•  ìˆ˜ ìˆì–´ìš”</p>
    </div>
    <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
    
	<div id="workspace" style="display: none;">
   <!--ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë§¨ ìœ„ë¡œ ì´ë™-->
   <div class="preview-section">
       <h3> ë¯¸ë¦¬ë³´ê¸° </h3>
       <canvas id="preview-canvas">  </canvas>
       </div>

       <div class="download-buttons">
       <button class="download-btn" id="download-btn"> ğŸ’¾ JPGë¡œ ì €ì¥ </button>
       </div>

       <!--ì´ë¯¸ì§€ ëª©ë¡-->
       <div class="image-list" id="image-list">  </div>

       <div class="action-buttons">
       <button class="add-more-btn" id="add-more-btn"> â• ì´ë¯¸ì§€ ì¶”ê°€ </button>
       <button class="clear-btn" id="clear-btn"> ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ </button>
      </div>
      
      <div class="controls-panel">
        <div class="control-group">
          <h3>ë°°ì¹˜ ë°©í–¥</h3>
          <div class="direction-buttons" id="direction-buttons">
            <button data-direction="horizontal" class="active">â¡ï¸ ê°€ë¡œ</button>
            <button data-direction="vertical">â¬‡ï¸ ì„¸ë¡œ</button>
            <button data-direction="grid">âŠ ë°”ë‘‘íŒ</button>
          </div>
          <div class="grid-options" id="grid-options">
            <label>ì—´ ê°œìˆ˜</label>
            <div class="stepper">
              <input type="number" id="columns-input" value="2" min="2" max="6" step="1">
              <div class="stepper-btns">
                <button data-input="columns-input" data-step="1">ğŸ”¼</button>
                <button data-input="columns-input" data-step="-1">ğŸ”½</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="control-group">
          <h3>ìŠ¤íƒ€ì¼ ì˜µì…˜</h3>
          <div class="options-grid">
            <div>
              <label>ì´ë¯¸ì§€ ê°„ê²© (px)</label>
              <div class="stepper">
                <input type="number" id="gap-input" value="0" min="0" max="100" step="5">
                <div class="stepper-btns">
                  <button data-input="gap-input" data-step="5">ğŸ”¼</button>
                  <button data-input="gap-input" data-step="-5">ğŸ”½</button>
                </div>
              </div>
            </div>
            <div>
              <label>í…Œë‘ë¦¬ ë‘ê»˜ (px)</label>
              <div class="stepper">
                <input type="number" id="border-input" value="0" min="0" max="50" step="5">
                <div class="stepper-btns">
                  <button data-input="border-input" data-step="5">ğŸ”¼</button>
                  <button data-input="border-input" data-step="-5">ğŸ”½</button>
                </div>
              </div>
            </div>
            <div>
              <label>ë°°ê²½/í…Œë‘ë¦¬ ìƒ‰ìƒ</label>
              <input type="color" id="bg-color-input" value="#ffffff">
            </div>
            <div>
              <label>í¬ê¸° ê¸°ì¤€</label>
              <select id="size-mode-select">
                <option value="largest">ê°€ì¥ í° ì´ë¯¸ì§€</option>
                <option value="smallest">ê°€ì¥ ì‘ì€ ì´ë¯¸ì§€</option>
                <option value="first">ì²« ë²ˆì§¸ ì´ë¯¸ì§€</option>
                <option value="original">ì›ë³¸ ìœ ì§€</option>
                <option value="custom">ì§ì ‘ ì…ë ¥</option>
              </select>
            </div>
          </div>
          
          <!-- í¬ê¸° ì§ì ‘ ì…ë ¥ ì˜µì…˜ -->
          <div class="custom-size-options" id="custom-size-options">
            <label>ì¶œë ¥ í¬ê¸° ì„¤ì •</label>
            <div class="custom-size-row">
              <div>
                <label style="font-weight:normal; font-size:0.8rem;">ê°€ë¡œ</label>
                <input type="number" id="custom-width" value="1000" min="100" max="10000">
              </div>
              <div style="flex:0;">
                <label style="font-weight:normal; font-size:0.8rem;">&nbsp;</label>
                <button class="size-lock-btn" id="size-lock-btn" title="ë¹„ìœ¨ ê³ ì •">ğŸ”’</button>
              </div>
              <div>
                <label style="font-weight:normal; font-size:0.8rem;">ì„¸ë¡œ</label>
                <input type="number" id="custom-height" value="1000" min="100" max="10000">
              </div>
              <div>
                <label style="font-weight:normal; font-size:0.8rem;">ë‹¨ìœ„</label>
                <select id="size-unit">
                  <option value="px">px</option>
                  <option value="%">% (ì²« ì´ë¯¸ì§€ ê¸°ì¤€)</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const uploadBox=document.getElementById('upload-box');
    const fileInput=document.getElementById('file-input');
    const workspace=document.getElementById('workspace');
    const imageList=document.getElementById('image-list');
    const addMoreBtn=document.getElementById('add-more-btn');
    const clearBtn=document.getElementById('clear-btn');
    const directionButtons=document.getElementById('direction-buttons');
    const gridOptions=document.getElementById('grid-options');
    const columnsInput=document.getElementById('columns-input');
    const gapInput=document.getElementById('gap-input');
    const borderInput=document.getElementById('border-input');
    const bgColorInput=document.getElementById('bg-color-input');
    const sizeModeSelect=document.getElementById('size-mode-select');
    const customSizeOptions=document.getElementById('custom-size-options');
    const customWidthInput=document.getElementById('custom-width');
    const customHeightInput=document.getElementById('custom-height');
    const sizeLockBtn=document.getElementById('size-lock-btn');
    const sizeUnitSelect=document.getElementById('size-unit');
    const previewCanvas=document.getElementById('preview-canvas');
    const downloadBtn=document.getElementById('download-btn');
    const mainLinkBtn=document.getElementById('main-link');
    const cleanerLinkBtn=document.getElementById('cleaner-link');

    let images=[];
    let settings={
      direction: 'horizontal',
      columns: 2,
      gap: 0,
      border: 0,
      bgColor: '#ffffff',
      sizeMode: 'largest',
      customWidth: 1000,
      customHeight: 1000,
      sizeUnit: 'px',
      sizeLocked: true
    };
    let customAspectRatio=1;

    const preventDefaults=e => { e.preventDefault(); e.stopPropagation(); };

    function handleFiles(files) {
      const fileArray=Array.from(files).filter(f => f.type.startsWith('image/'));
      if (fileArray.length === 0) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤.');
        return;
      }

      let loadedCount=0;
      fileArray.forEach(file => {
        const img=new Image();
        img.onload=() => {
          images.push({
            file,
            img,
            name: file.name,
            width: img.naturalWidth,
            height: img.naturalHeight,
            rotation: 0,
            flipH: false,
            flipV: false
          });
          loadedCount++;
          if (loadedCount === fileArray.length) {
            // ì²« ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ì»¤ìŠ¤í…€ í¬ê¸° ì´ˆê¸°í™”
            if (images.length === fileArray.length) {
              customWidthInput.value=images[0].width;
              customHeightInput.value=images[0].height;
              customAspectRatio=images[0].width/images[0].height;
            }
            renderImageList();
            updatePreview();
            showWorkspace();
          }
        };
        img.src=URL.createObjectURL(file);
      });
    }

    function showWorkspace() {
      uploadBox.style.display='none';
      workspace.style.display='block';
      updateButtonStates();
    }

    function updateButtonStates() {
      downloadBtn.disabled=images.length <2;
      clearBtn.disabled=images.length === 0;
    }

    function moveImage(fromIndex, toIndex) {
      if (toIndex <0 || toIndex>= images.length) return;
      const [movedItem]=images.splice(fromIndex, 1);
      images.splice(toIndex, 0, movedItem);
      renderImageList();
      updatePreview();
    }

    function renderImageList() {
      imageList.innerHTML='';
      
      if (images.length === 0) {
        uploadBox.style.display='flex';
        workspace.style.display='none';
        return;
      }

      images.forEach((item, index) => {
        const div=document.createElement('div');
        div.className='image-item';
        div.dataset.index=index;
        
        const transformStyle=`transform: rotate(${item.rotation}deg) scaleX(${item.flipH ? -1 : 1}) scaleY(${item.flipV ? -1 : 1});`;
        
        div.innerHTML=`
          <div class="order-buttons">
            <button class="move-up-btn" title="ìœ„ë¡œ ì´ë™" ${index === 0 ? 'disabled' : ''}>ğŸ”¼</button>
            <button class="move-down-btn" title="ì•„ë˜ë¡œ ì´ë™" ${index === images.length - 1 ? 'disabled' : ''}>ğŸ”½</button>
          </div>
          <div class="thumbnail">
            <img src="${item.img.src}" alt="${item.name}" style="${transformStyle}">
          </div>
          <div class="content">
            <div class="info">
              <div class="name">${item.name}</div>
              <div class="size">${item.width} Ã— ${item.height}px</div>
            </div>
            <div class="item-buttons">
              <button class="item-btn rotate-btn" title="90Â° íšŒì „">ğŸ”„ íšŒì „</button>
              <button class="item-btn flip-h-btn" title="ì¢Œìš° ë°˜ì „">â†”ï¸ ì¢Œìš°</button>
              <button class="item-btn flip-v-btn" title="ìƒí•˜ ë°˜ì „">â†•ï¸ ìƒí•˜</button>
              <button class="item-btn remove-btn" title="ì‚­ì œ">âŒ ì‚­ì œ</button>
            </div>
          </div>
        `;
        
        div.querySelector('.move-up-btn').addEventListener('click', () => moveImage(index, index - 1));
        div.querySelector('.move-down-btn').addEventListener('click', () => moveImage(index, index + 1));
        
        div.querySelector('.rotate-btn').addEventListener('click', () => {
          item.rotation=(item.rotation + 90) % 360;
          renderImageList();
          updatePreview();
        });
        
        div.querySelector('.flip-h-btn').addEventListener('click', () => {
          item.flipH=! item.flipH;
          renderImageList();
          updatePreview();
        });
        
        div.querySelector('.flip-v-btn').addEventListener('click', () => {
          item.flipV=!item.flipV;
          renderImageList();
          updatePreview();
        });
        
        div.querySelector('.remove-btn').addEventListener('click', () => {
          images.splice(index, 1);
          renderImageList();
          updatePreview();
          updateButtonStates();
        });
        
        imageList.appendChild(div);
      });
      
      updateButtonStates();
    }

    function getTargetSize() {
      if (images.length === 0) return { width: 0, height: 0 };
      
      const widths=images.map(i => i.width);
      const heights=images.map(i => i.height);
      
      switch (settings.sizeMode) {
        case 'largest':
          return { width: Math.max(...widths), height: Math.max(...heights) };
        case 'smallest':
          return { width: Math.min(...widths), height: Math.min(...heights) };
        case 'first':
          return { width: images[0].width, height: images[0].height };
        case 'custom':
          let w=parseInt(customWidthInput.value) || 1000;
          let h=parseInt(customHeightInput.value) || 1000;
          if (settings.sizeUnit === '%' && images.length> 0) {
            w=Math.round(images[0].width * w/100);
            h=Math.round(images[0].height * h/100);
          }
          return { width: w, height: h };
        case 'original':
        default:
          return null;
      }
    }

    function updatePreview() {
      if (images.length === 0) return;

      const ctx=previewCanvas.getContext('2d');
      const gap=parseInt(gapInput.value) || 0;
      const border=parseInt(borderInput.value) || 0;
      const bgColor=bgColorInput.value;
      const targetSize=getTargetSize();
      const isOriginal=settings.sizeMode === 'original';

      let canvasWidth, canvasHeight;
      const count=images.length;
      
      const maxOriginalWidth=Math.max(...images.map(i => i.width));
      const maxOriginalHeight=Math.max(...images.map(i => i.height));

      if (settings.direction === 'horizontal') {
        if (isOriginal) {
          canvasWidth=images.reduce((sum, i) => sum + i.width, 0) + gap * (count - 1) + border * 2;
          canvasHeight=maxOriginalHeight + border * 2;
        } else {
          canvasWidth=targetSize.width * count + gap * (count - 1) + border * 2;
          canvasHeight=targetSize.height + border * 2;
        }
      } else if (settings.direction === 'vertical') {
        if (isOriginal) {
          canvasWidth=maxOriginalWidth + border * 2;
          canvasHeight=images.reduce((sum, i) => sum + i.height, 0) + gap * (count - 1) + border * 2;
        } else {
          canvasWidth=targetSize.width + border * 2;
          canvasHeight=targetSize.height * count + gap * (count - 1) + border * 2;
        }
      } else {
        const cols=Math.min(parseInt(columnsInput.value) || 2, count);
        const rows=Math.ceil(count/cols);
        if (isOriginal) {
          canvasWidth=maxOriginalWidth * cols + gap * (cols - 1) + border * 2;
          canvasHeight=maxOriginalHeight * rows + gap * (rows - 1) + border * 2;
        } else {
          canvasWidth=targetSize.width * cols + gap * (cols - 1) + border * 2;
          canvasHeight=targetSize.height * rows + gap * (rows - 1) + border * 2;
        }
      }

      previewCanvas.width=canvasWidth;
      previewCanvas.height=canvasHeight;

      ctx.fillStyle=bgColor;
      ctx.fillRect(0, 0, canvasWidth, canvasHeight);

      let currentX=border;
      let currentY=border;
      const cols=settings.direction === 'grid' ? Math.min(parseInt(columnsInput.value) || 2, count) : count;

      images.forEach((item, index) => {
        let cellWidth, cellHeight;
        
        if (isOriginal) {
          if (settings.direction === 'horizontal') {
            cellWidth=item.width;
            cellHeight=maxOriginalHeight;
          } else if (settings.direction === 'vertical') {
            cellWidth=maxOriginalWidth;
            cellHeight=item.height;
          } else {
            cellWidth=maxOriginalWidth;
            cellHeight=maxOriginalHeight;
          }
        } else {
          cellWidth=targetSize.width;
          cellHeight=targetSize.height;
        }

        let drawWidth, drawHeight;
        if (isOriginal) {
          drawWidth=item.width;
          drawHeight=item.height;
        } else {
          const ratio=Math.min(cellWidth/item.width, cellHeight/item.height);
          drawWidth=item.width * ratio;
          drawHeight=item.height * ratio;
        }
        
        const offsetX=(cellWidth - drawWidth)/2;
        const offsetY=(cellHeight - drawHeight)/2;

        ctx.save();
        ctx.translate(currentX + offsetX + drawWidth/2, currentY + offsetY + drawHeight/2);
        ctx.rotate((item.rotation * Math.PI)/180);
        ctx.scale(item.flipH ? -1 : 1, item.flipV ? -1 : 1);
        ctx.drawImage(item.img, -drawWidth/2, -drawHeight/2, drawWidth, drawHeight);
        ctx.restore();

        if (settings.direction === 'horizontal') {
          currentX += cellWidth + gap;
        } else if (settings.direction === 'vertical') {
          currentY += cellHeight + gap;
        } else {
          if ((index + 1) % cols === 0) {
            currentX=border;
            currentY += cellHeight + gap;
          } else {
            currentX += cellWidth + gap;
          }
        }
      });
    }

    function downloadImage() {
      if (images.length <2) return;
      
      previewCanvas.toBlob((blob) => {
        const timestamp=new Date().toISOString().slice(0, 10).replace(/-/g, '');
        const fileName=`gallery_${timestamp}.jpg`;
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download=fileName;
        a.click();
        URL.revokeObjectURL(a.href);
      }, 'image/jpeg', 0.95);
    }

    function setupSteppers() {
      document.querySelectorAll('.stepper-btns button').forEach(button => {
        button.addEventListener('click', () => {
          const input=document.getElementById(button.dataset.input);
          const step=parseInt(button.dataset.step, 10);
          let value=parseInt(input.value, 10) || 0;
          value += step;
          value=Math.max(parseInt(input.min), Math.min(parseInt(input.max), value));
          input.value=value;
          input.dispatchEvent(new Event('input'));
        });
      });
    }

    // Event Listeners
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => uploadBox.addEventListener(e, preventDefaults, false));
    ['dragenter', 'dragover'].forEach(e => uploadBox.addEventListener(e, () => uploadBox.classList.add('dragover'), false));
    ['dragleave', 'drop'].forEach(e => uploadBox.addEventListener(e, () => uploadBox.classList.remove('dragover'), false));
    
    uploadBox.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
    uploadBox.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => { handleFiles(e.target.files); fileInput.value=''; });
    addMoreBtn.addEventListener('click', () => fileInput.click());
    
    clearBtn.addEventListener('click', () => {
      if (confirm('ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) {
        images=[];
        renderImageList();
      }
    });

    directionButtons.addEventListener('click', e => {
      if (e.target.tagName !== 'BUTTON') return;
      directionButtons.querySelector('.active')?.classList.remove('active');
      e.target.classList.add('active');
      settings.direction=e.target.dataset.direction;
      gridOptions.classList.toggle('visible', settings.direction === 'grid');
      updatePreview();
    });

    columnsInput.addEventListener('input', () => { settings.columns=parseInt(columnsInput.value) || 2; updatePreview(); });
    gapInput.addEventListener('input', updatePreview);
    borderInput.addEventListener('input', updatePreview);
    bgColorInput.addEventListener('input', updatePreview);
    
    sizeModeSelect.addEventListener('change', e => { 
      settings.sizeMode=e.target.value;
      customSizeOptions.classList.toggle('visible', settings.sizeMode === 'custom');
      updatePreview(); 
    });

    // í¬ê¸° ì§ì ‘ ì…ë ¥ ê´€ë ¨
    customWidthInput.addEventListener('input', () => {
      if (settings.sizeLocked) {
        customHeightInput.value=Math.round(customWidthInput.value/customAspectRatio);
      }
      updatePreview();
    });
    
    customHeightInput.addEventListener('input', () => {
      if (settings.sizeLocked) {
        customWidthInput.value=Math.round(customHeightInput.value * customAspectRatio);
      }
      updatePreview();
    });
    
    sizeLockBtn.addEventListener('click', () => {
      settings.sizeLocked=!settings.sizeLocked;
      sizeLockBtn.textContent=settings.sizeLocked ?  'ğŸ”’' : 'ğŸ”“';
      if (settings.sizeLocked) {
        customAspectRatio=customWidthInput.value/customHeightInput.value;
      }
    });
    
    sizeUnitSelect.addEventListener('change', e => {
      settings.sizeUnit=e.target.value;
      if (e.target.value === '%') {
        customWidthInput.value=100;
        customHeightInput.value=100;
        customWidthInput.max=500;
        customHeightInput.max=500;
      } else {
        if (images.length> 0) {
          customWidthInput.value=images[0].width;
          customHeightInput.value=images[0].height;
        }
        customWidthInput.max=10000;
        customHeightInput.max=10000;
      }
      customAspectRatio=customWidthInput.value/customHeightInput.value;
      updatePreview();
    });

    downloadBtn.addEventListener('click', downloadImage);

    mainLinkBtn.addEventListener('click', () => { window.location.href="https://toastout.github.io/toast/"; });
    cleanerLinkBtn.addEventListener('click', () => { window.location.href="https://toastout.github.io/toast5/"; });
    
    setupSteppers();
});
</script>
</body>
</html>